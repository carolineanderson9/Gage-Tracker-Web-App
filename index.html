<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- PWA / iOS Standalone Support -->
  <meta name="theme-color" content="#3498db">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <title>Gage Tracker - Excel Tool & Mfg.</title>
  <style>
    * { box-sizing: border-box; touch-action: manipulation; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh; color: #333;
      -webkit-overflow-scrolling: touch;
    }

    /* FAB */
    .fab {
      position: fixed; bottom: 32px; right: 32px;
      width: 72px; height: 72px; border-radius: 50%;
      background: #27ae60; color: white;
      font-size: 48px; line-height: 72px; text-align: center;
      border: none; box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      z-index: 999; cursor: pointer; transition: all 0.2s ease;
    }
    .fab:active { transform: scale(0.92); }

    /* Login & popups */
    .login-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .login-box {
      background: white; padding: 40px; border-radius: 15px;
      text-align: center; max-width: 90%; width: 400px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      margin: 20px;
    }
    .login-input {
      width: 100%; padding: 16px; margin: 15px 0; border: 2px solid #bdc3c7;
      border-radius: 8px; font-size: 18px;
    }
    .login-btn {
      width: 100%; padding: 16px; background: #3498db; color: white;
      border: none; border-radius: 8px; font-size: 18px; cursor: pointer;
    }

    .popup-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center;
      z-index: 1000; display: none;
    }
    .popup-box {
      background: white; padding: 40px; border-radius: 15px;
      text-align: center; max-width: 95%; width: 500px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3); margin: 20px;
      max-height: 90vh; overflow-y: auto; position: relative;
    }

    /* Main app */
    .container {
      max-width: 100%; width: 100%; padding: 25px;
      background: white; min-height: 100vh; display: none;
    }
    @media (min-width: 769px) {
      .container { max-width: 900px; margin: 20px auto; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    }
    .employee-info {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white; padding: 20px; border-radius: 10px;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 25px; flex-wrap: wrap; gap: 15px;
    }
    h1, .subtitle { text-align: center; }
    .add-gage-btn, .backup-btn {
      background: rgba(255,255,255,0.2); color: white; border: 2px solid white;
      border-radius: 25px; font-size: 16px; cursor: pointer;
      padding: 12px 20px; min-height: 45px;
    }
    .add-gage-btn:active, .backup-btn:active { background: white; color: #3498db; transform: scale(0.98); }

    /* Search */
    #searchSection {
      position: sticky; top: 0; z-index: 10; background: #f8f9fa; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; gap: 15px; flex-direction: column;
    }
    @media (min-width: 769px) { #searchSection { flex-direction: row; } }
    .search-wrapper { position: relative; flex: 1; }
    #searchInput { width: 100%; padding: 16px 40px 16px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 18px; }
    #clearSearch { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; color: #999; cursor: pointer; display: none; }

    /* Empty state */
    .empty-state { text-align: center; padding: 80px 20px; color: #6c757d; background: #f8f9fa; border-radius: 12px; margin: 40px 0; }
    .empty-state .icon { font-size: 100px; margin-bottom: 20px; opacity: 0.7; }
    .empty-state h2 { margin: 0 0 12px; color: #2c3e50; font-size: 26px; }

    /* Gage cards */
    #gaugesList { margin-top: 30px; }
    .gage-item { background: white; margin: 20px 0; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 5px solid #3498db; overflow: hidden; }
    .gage-header { padding: 20px; background: #f8f9fa; cursor: pointer; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; }
    .gage-id { font-weight: 700; font-size: 20px; color: #2c3e50; display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .gage-status { padding: 10px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; min-width: 100px; text-align: center; }
    .gage-details { padding: 20px; display: grid; gap: 15px; }
    @media (min-width: 769px) { .gage-details { grid-template-columns: repeat(3, 1fr); } }
    .detail-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
    .gage-actions { padding: 20px; background: #f8f9fa; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; border-top: 1px solid #dee2e6; }
    .gage-actions button { padding: 14px 20px; min-height: 50px; flex: 1 1 120px; font-weight: 600; border: none; border-radius: 8px; color: white; }
    .notes-indicator { position: absolute; top: 10px; right: 10px; background: #2ecc71; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }

    /* Status colors */
    .status-available { background: #d4edda; color: #155724; }
    .status-in-use { background: #fff3cd; color: #856404; }
    .status-calibration { background: #e2d8f7; color: #4b0082; }
    .status-limit { background: #f8d7da; color: #721c24; }
    .limit-warning { background: #f8d7da !important; color: #721c24 !important; padding: 20px; font-weight: 700; text-align: center; }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>Employee Login</h2>
      <p>Enter your name to access Gage Tracker</p>
      <input type="text" class="login-input" id="employeeName" placeholder="e.g., John Smith">
      <button class="login-btn" id="continueBtn">Continue</button>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="container" id="mainApp">
    <div class="employee-info">
      <strong>Logged in as: <span id="currentEmployee"></span></strong>
      <button class="backup-btn" onclick="exportBackup()">Export Backup</button>
      <button class="backup-btn" onclick="importBackup()">Import Backup</button>
      <button class="backup-btn" onclick="showFullHistory()">View History</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <h1>Gage Tracker</h1>
    <p class="subtitle">Excel Tool & Mfg. - <strong>Gage</strong> Management System</p>

    <div id="searchSection">
      <div class="search-wrapper">
        <input type="text" id="searchInput" placeholder="Search by Gage ID or Size..." oninput="searchGages(this.value)">
        <button id="clearSearch" onclick="clearSearch()">Ã—</button>
      </div>
      <button id="searchBtn" onclick="performSearch()">Search</button>
    </div>

    <div id="gaugesList"></div>
  </div>

  <!-- FAB -->
  <button class="fab" aria-label="Add new gage">+</button>

  <!-- Hidden import input -->
  <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(this.files[0])">

  <script>
    let gauges = JSON.parse(localStorage.getItem('gauges') || '[]');
    let historyLog = JSON.parse(localStorage.getItem('historyLog') || '[]');
    let currentEmployee = '';

    function saveData() {
      localStorage.setItem('gauges', JSON.stringify(gauges));
      localStorage.setItem('historyLog', JSON.stringify(historyLog));
    }

    function logAction(action, details) {
      historyLog.push({
        timestamp: new Date().toLocaleString(),
        employee: currentEmployee || 'Unknown',
        action,
        details
      });
      saveData();
    }

    function login() {
      console.log("login() called");
      const nameInput = document.getElementById('employeeName');
      const name = nameInput ? nameInput.value.trim() : '';
      if (!name) {
        alert('Please enter your name');
        return;
      }
      currentEmployee = name;
      const employeeSpan = document.getElementById('currentEmployee');
      if (employeeSpan) employeeSpan.textContent = name;

      const overlay = document.getElementById('loginOverlay');
      const main = document.getElementById('mainApp');
      if (overlay) overlay.style.display = 'none';
      if (main) main.style.display = 'block';

      loadGages();
      checkAutoBackup();
      console.log("Login successful - main app displayed");
    }

    // Attach login button listener safely
    document.addEventListener('DOMContentLoaded', () => {
      const continueBtn = document.getElementById('continueBtn');
      if (continueBtn) {
        continueBtn.addEventListener('click', login);
      }
      // Also support Enter key
      const nameInput = document.getElementById('employeeName');
      if (nameInput) {
        nameInput.addEventListener('keypress', e => {
          if (e.key === 'Enter') login();
        });
      }
    });

    window.logout = () => {
      currentEmployee = '';
      document.getElementById('loginOverlay').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('employeeName').value = '';
      document.getElementById('gaugesList').innerHTML = '';
    };

    // ... (rest of your functions: addNewGage, saveNewGage, loadGages, searchGages, performSearch, clearSearch, exportBackup, importBackup, handleImport, checkAutoBackup, showFullHistory, exportHistory, showGageProfile, editNotes, saveNotes, editGage, saveEdit, deleteGage, checkoutToCalibration, returnFromCalibration, checkoutGauge, confirmCheckout, checkinGauge, confirmCheckIn, closePopup)

    window.addNewGage = () => {
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.style.display = 'flex';
      popup.innerHTML = `
        <div class="popup-box">
          <h3>Add New Gage</h3>
          <label>Gage ID:</label><input type="text" id="newGageId" required>
          <label>Gage Type:</label><input type="text" id="newGageType" required>
          <label>Size:</label><input type="text" id="newSize" required>
          <label>Last Calibration Date:</label><input type="date" id="newLastCalibrationDate" required>
          <label>Calibration Due Date:</label><input type="date" id="newCalibrationDueDate" required>
          <label>Total Uses Allowed:</label><input type="number" id="newTotalUsesAllowed" value="300" min="1" required>
          <label>Notes:</label><textarea id="newNotes" placeholder="Add any notes about this gage..."></textarea>
          <div class="popup-btn-group">
            <button class="btn-save" onclick="saveNewGage()">Save</button>
            <button class="btn-cancel" onclick="closePopup()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
    };

    // (insert all your other functions here as in previous versions - saveNewGage, loadGages, searchGages, performSearch, clearSearch, exportBackup, importBackup, handleImport, checkAutoBackup, showFullHistory, exportHistory, etc.)

    window.closePopup = () => {
      document.querySelectorAll('.popup-overlay').forEach(p => p.remove());
    };

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closePopup(); });

    // FAB listener
    document.addEventListener('DOMContentLoaded', () => {
      const fab = document.querySelector('.fab');
      if (fab) fab.addEventListener('click', addNewGage);
    });

    // Initial load (will run after login)
    loadGages();
  </script>
</body>
</html>
