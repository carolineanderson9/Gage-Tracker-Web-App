<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- PWA / iOS Standalone Support -->
  <meta name="theme-color" content="#3498db">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <title>Gage Tracker - Excel Tool & Mfg.</title>
<style>
  * { box-sizing: border-box; touch-action: manipulation; }
  body {
    font-family: system-ui, -apple-system, sans-serif;
    margin: 0; padding: 0;
    background: linear-gradient(135deg, #f6f8fc 0%, #d9e3f0 100%);
    min-height: 100vh; color: #2c3e50;
  }

  .fab {
    position: fixed; bottom: 32px; right: 32px;
    width: 60px; height: 60px; border-radius: 50%;
    background: #3498db; color: white;
    font-size: 36px; line-height: 60px; text-align: center;
    border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 999; cursor: pointer;
  }
  .fab:active { transform: scale(0.95); }

  .login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; justify-content: center; align-items: center; z-index: 1000; }
  .login-box { background: white; padding: 32px; border-radius: 12px; width: 360px; max-width: 90%; box-shadow: 0 6px 20px rgba(0,0,0,0.2); text-align: center; }
  .login-input { width: 100%; padding: 12px; margin: 12px 0; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
  .login-btn { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }

  .popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; justify-content: center; align-items: center; z-index: 1000; display: none; }
  .popup-box { background: white; padding: 32px; border-radius: 12px; max-width: 95%; width: 480px; max-height: 85vh; overflow-y: auto; box-shadow: 0 6px 20px rgba(0,0,0,0.2); position: relative; }
  .popup-box label { display: block; margin: 8px 0 4px; text-align: left; font-weight: 600; color: #4b5563; }
  .popup-box input, .popup-box textarea, .popup-box select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
  .popup-btn-group { display: flex; gap: 12px; margin-top: 20px; }
  .btn-save { background: #10b981; color: white; flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }
  .btn-cancel { background: #9ca3af; color: white; flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }

  .container { padding: 24px; background: white; min-height: 100vh; display: none; }
  .employee-info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
  h1 { text-align: center; color: #1f2937; margin: 0 0 8px; font-size: 24px; font-weight: 600; }
  .subtitle { text-align: center; color: #6b7280; margin-bottom: 24px; font-size: 16px; }

  .btn, .logout-btn { background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; padding: 8px 16px; cursor: pointer; }
  .logout-btn { background: #ef4444; }
  .menu-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0 8px; }
  .menu-popup { position: absolute; top: 48px; right: 16px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; display: none; padding: 8px 0; min-width: 180px; }
  .menu-item { padding: 12px 20px; color: #4b5563; border-bottom: 1px solid #f3f4f6; cursor: pointer; background: none; border: none; width: 100%; text-align: left; font-size: 14px; }
  .menu-item:last-child { border-bottom: none; }
  .menu-item:hover { background: #f9fafb; }

  #searchSection { position: sticky; top: 0; z-index: 10; background: #f9fafb; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; gap: 12px; flex-direction: column; }
  @media (min-width: 769px) { #searchSection { flex-direction: row; } }
  .search-wrapper { position: relative; flex: 1; }
  #searchInput { width: 100%; padding: 12px 36px 12px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
  #clearSearch { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 20px; color: #9ca3af; cursor: pointer; display: none; }

  #categoryTabs { display: flex; gap: 8px; margin: 16px 0; overflow-x: auto; padding-bottom: 8px; }
  #categoryTabs button { background: #e5e7eb; color: #4b5563; border: none; border-radius: 20px; padding: 8px 16px; cursor: pointer; white-space: nowrap; }
  #categoryTabs button.active { background: #3b82f6; color: white; }

  .empty-state { text-align: center; padding: 64px 16px; color: #6b7280; background: #f9fafb; border-radius: 12px; margin: 32px 0; }
  .empty-state .icon { font-size: 80px; margin-bottom: 16px; opacity: 0.6; }

  .gage-item { background: white; margin: 16px 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #3b82f6; overflow: hidden; }
  .gage-header { padding: 16px; background: #f9fafb; cursor: pointer; border-bottom: 1px solid #e5e7eb; }
  .gage-id { font-weight: 600; font-size: 18px; color: #1f2937; display: flex; justify-content: space-between; align-items: center; }
  .gage-status { padding: 8px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; min-width: 90px; text-align: center; }
  .gage-details { padding: 16px; display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
  .detail-item { text-align: center; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
  .gage-actions { padding: 16px; background: #f9fafb; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; border-top: 1px solid #e5e7eb; }
  .gage-actions button { padding: 8px 16px; min-height: 36px; font-weight: 600; border: none; border-radius: 8px; color: white; cursor: pointer; }

  /* Distinct button colors */
  .btn-checkout { background: #f59e0b; }              /* Orange */
  .btn-calibration { background: #8b5cf6; }           /* Purple */
  .btn-return-calibration { background: #eab308; }    /* Yellow */
  .btn-checkin { background: #059669; }               /* Bright emerald green - distinct */
  .btn-notes { background: #14b8a6; }                 /* Teal - different from Check In */
  .btn-edit { background: #06b6d4; }                  /* Cyan */
  .btn-delete { background: #ef4444; }                /* Red */

  .status-available { background: #d1fae5; color: #065f46; }
  .status-in-use { background: #fef3c7; color: #92400e; }
  .status-calibration { background: #ede9fe; color: #6d28d9; }
  .status-limit { background: #fee2e2; color: #b91c1c; }
  .limit-warning { background: #fee2e2 !important; color: #b91c1c !important; padding: 16px; font-weight: 600; text-align: center; }

  /* Professional profile layout */
  .profile-info { display: grid; gap: 12px; margin: 16px 0; }
  .profile-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
  .profile-label { font-weight: 600; color: #4b5563; flex: 1; }
  .profile-value { font-weight: 500; color: #1f2937; text-align: right; flex: 2; }
  .profile-notes { margin-top: 16px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; white-space: pre-wrap; line-height: 1.5; }
</style>
</head>
<body>

  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>Employee Login</h2>
      <p>Enter your name to access Gage Tracker</p>
      <input type="text" class="login-input" id="employeeName" placeholder="e.g., John Smith">
      <button class="login-btn" id="continueBtn">Continue</button>
    </div>
  </div>

  <div class="container" id="mainApp">
    <div class="employee-info">
      <strong>Logged in as: <span id="currentEmployee"></span></strong>
      <button class="menu-btn" id="menuBtn">‚ãØ</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="menu-popup" id="menuPopup">
      <button class="menu-item" onclick="exportBackup(); toggleMenu()">Export Backup</button>
      <button class="menu-item" onclick="importBackup(); toggleMenu()">Import Backup</button>
      <button class="menu-item" onclick="showFullHistory(); toggleMenu()">View History</button>
    </div>

    <h1>Gage Tracker</h1>
    <p class="subtitle">Excel Tool & Mfg. - Gage Management System</p>

    <div id="searchSection">
      <div class="search-wrapper">
        <input type="text" id="searchInput" placeholder="Search by Gage ID or Size..." oninput="searchGages(this.value)">
        <button id="clearSearch" onclick="clearSearch()">√ó</button>
      </div>
      <button id="searchBtn" onclick="performSearch()">Search</button>
    </div>

    <div id="categoryTabs">
      <button class="btn active" data-category="All">All</button>
      <button class="btn" data-category="Plug Gages">Plug Gages</button>
      <button class="btn" data-category="Ring Gages">Ring Gages</button>
      <button class="btn" data-category="Misc Gages">Misc Gages</button>
    </div>

    <div id="gaugesList"></div>
  </div>

  <button class="fab" aria-label="Add new gage">+</button>

  <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(this.files[0])">

  <script>
    let gauges = JSON.parse(localStorage.getItem('gauges') || '[]');
    let historyLog = JSON.parse(localStorage.getItem('historyLog') || '[]');
    let currentEmployee = '';
    let currentCategory = 'All';
    let currentSearchTerm = '';

    function saveData() {
      localStorage.setItem('gauges', JSON.stringify(gauges));
      localStorage.setItem('historyLog', JSON.stringify(historyLog));
    }

    function logAction(action, details) {
      historyLog.push({
        timestamp: new Date().toLocaleString(),
        employee: currentEmployee || 'Unknown',
        action,
        details
      });
      saveData();
    }

    function login() {
      const name = document.getElementById('employeeName')?.value.trim();
      if (!name) return alert('Please enter your name');
      currentEmployee = name;
      document.getElementById('currentEmployee').textContent = name;
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      loadGages();
      checkAutoBackup();
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('continueBtn')?.addEventListener('click', login);
      document.getElementById('employeeName')?.addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
      document.querySelector('.fab')?.addEventListener('click', addNewGage);
      document.getElementById('menuBtn')?.addEventListener('click', toggleMenu);
      document.querySelectorAll('#categoryTabs button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#categoryTabs button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = btn.dataset.category;
          loadGages(currentSearchTerm);
        });
      });
      document.getElementById('searchInput')?.addEventListener('input', () => {
        document.getElementById('clearSearch').style.display = document.getElementById('searchInput').value.trim() ? 'block' : 'none';
      });
    });

    function toggleMenu() {
      const menu = document.getElementById('menuPopup');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function addNewGage() {
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.style.display = 'flex';
      popup.innerHTML = `
        <div class="popup-box">
          <h3>Add New Gage</h3>
          <label>Category:</label>
          <select id="newCategory">
            <option>Plug Gages</option>
            <option>Ring Gages</option>
            <option>Misc Gages</option>
          </select>
          <label>Gage ID:</label><input type="text" id="newGageId" required>
          <label>Size:</label><input type="text" id="newSize" required>
          <label>Last Calibration Date:</label><input type="date" id="newLastCalibrationDate" required>
          <label>Calibration Due Date:</label><input type="date" id="newCalibrationDueDate" required>
          <label>Total Uses Allowed:</label><input type="number" id="newTotalUsesAllowed" value="300" min="1" required>
          <label><input type="checkbox" id="newIsSTI"> STI Gage</label>
          <label><input type="checkbox" id="newIsMetric"> Metric Gage</label>
          <label>Notes:</label><textarea id="newNotes"></textarea>
          <div class="popup-btn-group">
            <button class="btn-save" onclick="saveNewGage()">Save</button>
            <button class="btn-cancel" onclick="closePopup()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function saveNewGage() {
      const category = document.getElementById('newCategory').value;
      const gageId = document.getElementById('newGageId').value.trim();
      const size = document.getElementById('newSize').value.trim();
      const lastCalibrationDate = document.getElementById('newLastCalibrationDate').value;
      const calibrationDueDate = document.getElementById('newCalibrationDueDate').value;
      const totalUsesAllowed = parseInt(document.getElementById('newTotalUsesAllowed').value);
      const isSTI = document.getElementById('newIsSTI').checked;
      const isMetric = document.getElementById('newIsMetric').checked;
      const notes = document.getElementById('newNotes').value.trim();

      if (!category || !gageId || !size || !lastCalibrationDate || !calibrationDueDate || isNaN(totalUsesAllowed)) {
        alert('Please fill in all required fields');
        return;
      }

      gauges.push({
        category, gageId, size, lastCalibrationDate, calibrationDueDate, totalUsesAllowed,
        isSTI, isMetric, notes, totalUses: 0, inUse: false, usageLimitReached: false,
        checkedOutBy: null
      });
      logAction('Added new gage', { gageId, category, size });
      saveData();
      alert('New gage added successfully!');
      closePopup();
      loadGages(currentSearchTerm);
    }

    function loadGages(searchTerm = '') {
      currentSearchTerm = searchTerm;
      const list = document.getElementById('gaugesList');
      list.innerHTML = '<h3>Gage Catalog</h3>';
      let html = '';
      let foundAny = false;
      const lowerSearch = searchTerm.toLowerCase().trim();

      gauges.forEach((g, i) => {
        if (currentCategory !== 'All' && g.category !== currentCategory) return;
        if (lowerSearch && !g.gageId.toLowerCase().includes(lowerSearch) && !g.size.toLowerCase().includes(lowerSearch)) return;
        foundAny = true;

        let status = 'AVAILABLE', statusClass = 'status-available';
        let checkoutBtn = '', checkinBtn = '', calBtn = '', returnCalBtn = '', limitWarning = '';
        let notesIndicator = g.notes ? '<div class="notes-indicator">N</div>' : '';

        if (g.inUse) {
          status = 'IN USE'; statusClass = 'status-in-use';
          checkinBtn = `<button class="btn-checkin" data-index="${i}">Check In</button>`;
        } else if (g.toCalibration) {
          status = 'CALIBRATION'; statusClass = 'status-calibration';
          returnCalBtn = `<button class="btn-return-calibration" data-index="${i}">Return from Cal</button>`;
        } else if (g.usageLimitReached) {
          status = 'LIMIT REACHED'; statusClass = 'status-limit';
          limitWarning = `<div class="limit-warning">USAGE LIMIT REACHED</div>`;
        } else {
          checkoutBtn = `<button class="btn-checkout" data-index="${i}">Check Out</button>`;
          calBtn = `<button class="btn-calibration" data-index="${i}">To Calibration</button>`;
        }

        const remaining = g.totalUsesAllowed - (g.totalUses || 0);

        html += `
          <div class="gage-item">
            <div class="gage-header" data-index="${i}">
              <div class="gage-id">
                <span>${g.gageId}</span>
                <span class="gage-status ${statusClass}">${status}</span>
                ${notesIndicator}
              </div>
            </div>
            <div class="gage-details">
              <div class="detail-item"><div class="detail-label">Size</div><div class="detail-value">${g.size}</div></div>
              <div class="detail-item"><div class="detail-label">Due Date</div><div class="detail-value">${g.calibrationDueDate}</div></div>
              <div class="detail-item"><div class="detail-label">Remaining Uses</div><div class="detail-value">${remaining}</div></div>
              ${g.isSTI ? '<div class="detail-item"><div class="detail-label">STI</div><div class="detail-value">Yes</div></div>' : ''}
              ${g.isMetric ? '<div class="detail-item"><div class="detail-label">Metric</div><div class="detail-value">Yes</div></div>' : ''}
            </div>
            ${limitWarning}
            <div class="gage-actions">
              ${checkoutBtn}${calBtn}${checkinBtn}${returnCalBtn}
              <button class="btn-notes" data-index="${i}">Notes</button>
              <button class="btn-edit" data-index="${i}">Edit</button>
              <button class="btn-delete" data-index="${i}">Remove</button>
            </div>
          </div>
        `;
      });

      if (!foundAny) {
        list.innerHTML += `
          <div class="empty-state">
            <div class="icon">üîç</div>
            <h2>No gauges found</h2>
            <p>Use the + button below to add a gage.</p>
          </div>
        `;
      } else {
        list.innerHTML += html;
      }

      // Attach event listeners
      document.querySelectorAll('.gage-header').forEach(header => {
        header.addEventListener('click', () => showGageProfile(parseInt(header.dataset.index)));
      });
      document.querySelectorAll('.btn-checkout').forEach(btn => {
        btn.addEventListener('click', e => { e.stopPropagation(); checkoutGauge(parseInt(btn.dataset.index)); });
      });
      document.querySelectorAll('.btn-calibration').forEach(btn => {
        btn.addEventListener('click', e => { e.stopPropagation(); checkoutToCalibration(parseInt(btn.dataset.index)); });
      });
      document.querySelectorAll('.btn-checkin').forEach(btn => {
        btn.addEventListener('click', e => { e.stopPropagation(); checkinGauge(parseInt(btn.dataset.index)); });
      });
      document.querySelectorAll('.btn-return-calibration').forEach(btn => {
        btn.addEventListener('click', e => { e.stopPropagation(); returnFromCalibration(parseInt(btn.dataset.index)); });
      });
      document.querySelectorAll('.btn-notes').forEach(btn => {
        btn.addEventListener('click', e => { e.stopPropagation(); editNotes(parseInt(btn.dataset.index)); });
      });
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', e => { e.stopPropagation(); editGage(parseInt(btn.dataset.index)); });
      });
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', e => { e.stopPropagation(); deleteGage(parseInt(btn.dataset.index)); });
      });
    }

    function showGageProfile(i) {
      const g = gauges[i];
      const remaining = g.totalUsesAllowed - (g.totalUses || 0);
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.style.display = 'flex';
      popup.innerHTML = `
        <div class="popup-box">
          <h3>Gage Profile: ${g.gageId}</h3>
          <div class="profile-info">
            <div class="profile-row">
              <span class="profile-label">Category</span>
              <span class="profile-value">${g.category}</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">Size</span>
              <span class="profile-value">${g.size}</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">Last Calibration</span>
              <span class="profile-value">${g.lastCalibrationDate || 'N/A'}</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">Calibration Due</span>
              <span class="profile-value">${g.calibrationDueDate}</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">Uses Allowed</span>
              <span class="profile-value">${g.totalUsesAllowed}</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">Used</span>
              <span class="profile-value">${g.totalUses || 0}</span>
            </div>
            <div class="profile-row">
              <span class="profile-label">Remaining Uses</span>
              <span class="profile-value">${remaining}</span>
            </div>
            ${g.isSTI ? `
              <div class="profile-row">
                <span class="profile-label">STI Gage</span>
                <span class="profile-value">Yes</span>
              </div>
            ` : ''}
            ${g.isMetric ? `
              <div class="profile-row">
                <span class="profile-label">Metric Gage</span>
                <span class="profile-value">Yes</span>
              </div>
            ` : ''}
            <div class="profile-row">
              <span class="profile-label">Status</span>
              <span class="profile-value ${g.inUse ? 'status-in-use' : g.toCalibration ? 'status-calibration' : g.usageLimitReached ? 'status-limit' : 'status-available'}">
                ${g.inUse ? 'In Use' : g.toCalibration ? 'In Calibration' : g.usageLimitReached ? 'Limit Reached' : 'Available'}
              </span>
            </div>
            ${g.inUse && g.checkedOutBy ? `
              <div class="profile-row">
                <span class="profile-label">Checked Out By</span>
                <span class="profile-value">${g.checkedOutBy}</span>
              </div>
            ` : ''}
          </div>
          ${g.notes ? `
            <div class="profile-notes">
              <strong>Notes:</strong><br>${g.notes.replace(/\n/g, '<br>')}
            </div>
          ` : ''}
          <button class="btn-cancel" onclick="closePopup()">Close</button>
        </div>
      `;
      document.body.appendChild(popup);
    }

    // ... (your other functions: checkoutGauge, confirmCheckout, checkinGauge, confirmCheckIn, checkoutToCalibration, returnFromCalibration, editNotes, saveNotes, editGage, saveEdit, deleteGage, exportBackup, importBackup, handleImport, checkAutoBackup, showFullHistory, exportHistory, searchGages, performSearch, clearSearch)

    function checkoutGauge(i) {
      const g = gauges[i];
      if (g.usageLimitReached) return alert('USAGE LIMIT REACHED - Cannot check out!');
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.style.display = 'flex';
      popup.innerHTML = `
        <div class="popup-box">
          <h3>Check Out: ${g.gageId}</h3>
          <label>Job #:</label><input type="text" id="checkoutJob">
          <label>Date:</label><input type="date" id="checkoutDate" value="${new Date().toISOString().split('T')[0]}">
          <div class="popup-btn-group">
            <button class="btn-save" onclick="confirmCheckout(${i})">Confirm</button>
            <button class="btn-cancel" onclick="closePopup()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function confirmCheckout(i) {
      const job = document.getElementById('checkoutJob').value.trim();
      const date = document.getElementById('checkoutDate').value;
      if (!job) return alert('Please enter Job #');
      gauges[i].inUse = true;
      gauges[i].currentJob = job;
      gauges[i].checkoutDate = date;
      gauges[i].checkedOutBy = currentEmployee;
      gauges[i].toCalibration = false;
      logAction('Checked out gage', { gageId: gauges[i].gageId, job });
      saveData();
      alert(`${job} checked out by ${currentEmployee}`);
      closePopup();
      loadGages(currentSearchTerm);
    }

    function checkinGauge(i) {
      const g = gauges[i];
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.style.display = 'flex';
      popup.innerHTML = `
        <div class="popup-box">
          <h3>Check In: ${g.gageId}</h3>
          <label>Usage Amount:</label><input type="number" id="usageAmount" min="0" required>
          <div class="popup-btn-group">
            <button class="btn-save" onclick="confirmCheckIn(${i})">Confirm</button>
            <button class="btn-cancel" onclick="closePopup()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function confirmCheckIn(i) {
      const usageAmount = parseInt(document.getElementById('usageAmount').value);
      if (isNaN(usageAmount) || usageAmount < 0) return alert('Please enter a valid number');
      const newTotalUses = (gauges[i].totalUses || 0) + usageAmount;
      gauges[i].inUse = false;
      gauges[i].currentJob = '';
      gauges[i].checkedOutBy = null;
      gauges[i].totalUses = newTotalUses;
      gauges[i].checkedInBy = currentEmployee;
      gauges[i].lastUsageAmount = usageAmount;
      gauges[i].lastCheckIn = new Date().toISOString().split('T')[0];
      gauges[i].usageLimitReached = newTotalUses >= gauges[i].totalUsesAllowed;
      gauges[i].toCalibration = false;
      logAction('Checked in gage', { gageId: gauges[i].gageId, usageAmount });
      saveData();
      const message = gauges[i].usageLimitReached ? `${gauges[i].gageId} checked in - USAGE LIMIT REACHED!` : `${gauges[i].gageId} checked in. Usage: ${usageAmount}`;
      alert(message);
      closePopup();
      loadGages(currentSearchTerm);
    }

    function checkoutToCalibration(i) {
      gauges[i].toCalibration = true;
      gauges[i].inUse = false;
      gauges[i].checkedOutBy = currentEmployee;
      logAction('Sent to calibration', { gageId: gauges[i].gageId });
      saveData();
      alert(`${gauges[i].gageId} sent to calibration by ${currentEmployee}`);
      loadGages(currentSearchTerm);
    }

    function returnFromCalibration(i) {
      gauges[i].toCalibration = false;
      gauges[i].lastCalibrationDate = new Date().toISOString().split('T')[0];
      gauges[i].totalUses = 0;
      gauges[i].usageLimitReached = false;
      gauges[i].checkedOutBy = null;
      logAction('Returned from calibration', { gageId: gauges[i].gageId });
      saveData();
      alert(`${gauges[i].gageId} returned from calibration - reset to 0 uses`);
      loadGages(currentSearchTerm);
    }

    function editNotes(i) {
      const g = gauges[i];
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.style.display = 'flex';
      popup.innerHTML = `
        <div class="popup-box">
          <h3>Notes for ${g.gageId}</h3>
          <textarea id="editNotes" placeholder="Add notes...">${g.notes || ''}</textarea>
          <div class="popup-btn-group">
            <button class="btn-save" onclick="saveNotes(${i})">Save</button>
            <button class="btn-cancel" onclick="closePopup()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function saveNotes(i) {
      gauges[i].notes = document.getElementById('editNotes').value.trim();
      logAction('Updated notes', { gageId: gauges[i].gageId });
      saveData();
      alert('Notes saved!');
      closePopup();
      loadGages(currentSearchTerm);
    }

    function editGage(i) {
      const g = gauges[i];
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.style.display = 'flex';
      popup.innerHTML = `
        <div class="popup-box">
          <h3>Edit Gage: ${g.gageId}</h3>
          <label>Category:</label>
          <select id="editCategory">
            <option selected>${g.category}</option>
            <option>Plug Gages</option>
            <option>Ring Gages</option>
            <option>Misc Gages</option>
          </select>
          <label>Gage ID:</label><input type="text" id="editGageId" value="${g.gageId}" required>
          <label>Size:</label><input type="text" id="editSize" value="${g.size}" required>
          <label>Last Calibration Date:</label><input type="date" id="editLastCalibrationDate" value="${g.lastCalibrationDate}" required>
          <label>Calibration Due Date:</label><input type="date" id="editCalibrationDueDate" value="${g.calibrationDueDate}" required>
          <label>Total Uses Allowed:</label><input type="number" id="editTotalUsesAllowed" value="${g.totalUsesAllowed}" min="1" required>
          <label><input type="checkbox" id="editIsSTI" ${g.isSTI ? 'checked' : ''}> STI Gage</label>
          <label><input type="checkbox" id="editIsMetric" ${g.isMetric ? 'checked' : ''}> Metric Gage</label>
          <label>Notes:</label><textarea id="editNotes">${g.notes || ''}</textarea>
          <div class="popup-btn-group">
            <button class="btn-save" onclick="saveEdit(${i})">Save</button>
            <button class="btn-cancel" onclick="closePopup()">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function saveEdit(i) {
      const category = document.getElementById('editCategory').value;
      const gageId = document.getElementById('editGageId').value.trim();
      const size = document.getElementById('editSize').value.trim();
      const lastCalibrationDate = document.getElementById('editLastCalibrationDate').value;
      const calibrationDueDate = document.getElementById('editCalibrationDueDate').value;
      const totalUsesAllowed = parseInt(document.getElementById('editTotalUsesAllowed').value);
      const isSTI = document.getElementById('editIsSTI').checked;
      const isMetric = document.getElementById('editIsMetric').checked;
      const notes = document.getElementById('editNotes').value.trim();

      gauges[i] = { ...gauges[i], category, gageId, size, lastCalibrationDate, calibrationDueDate, totalUsesAllowed, isSTI, isMetric, notes };
      logAction('Edited gage', { gageId, category, size });
      saveData();
      alert('Gage updated successfully!');
      closePopup();
      loadGages(currentSearchTerm);
    }

    function deleteGage(i) {
      if (!confirm('Are you sure you want to remove this gage?')) return;
      const removed = gauges.splice(i, 1)[0];
      logAction('Deleted gage', { gageId: removed.gageId });
      saveData();
      alert('Gage removed');
      loadGages(currentSearchTerm);
    }

    function exportBackup() {
      const data = {
        gauges,
        historyLog,
        timestamp: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gage-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      alert('Backup exported successfully!');
    }

    function importBackup() {
      if (confirm('This will overwrite current data. Continue?')) {
        document.getElementById('importFile').click();
      }
    }

    function handleImport(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          gauges = data.gauges || [];
          historyLog = data.historyLog || [];
          saveData();
          loadGages();
          alert('Backup imported successfully!');
        } catch (err) {
          alert('Invalid backup file: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function checkAutoBackup() {
      const last = localStorage.getItem('lastBackup');
      if (!last || Date.now() - new Date(last).getTime() > 86400000) {
        if (confirm('It has been over 24 hours since last backup. Export now?')) {
          exportBackup();
          localStorage.setItem('lastBackup', Date.now().toString());
        }
      }
    }

    function showFullHistory() {
      let html = '';
      historyLog.slice().reverse().forEach(entry => {
        html += `
          <div style="margin:12px 0; padding:12px; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb;">
            <strong>${entry.timestamp} - ${entry.employee}</strong>: ${entry.action}<br>
            <pre style="margin:8px 0 0; white-space:pre-wrap; font-size:13px;">${JSON.stringify(entry.details, null, 2)}</pre>
          </div>
        `;
      });
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.style.display = 'flex';
      popup.innerHTML = `
        <div class="popup-box">
          <button class="btn-cancel" onclick="closePopup()" style="position:sticky; top:8px; float:right;">Close</button>
          <h3>Full Action History</h3>
          <div style="max-height:70vh; overflow-y:auto;">
            ${html || '<p style="text-align:center; color:#6b7280;">No history yet.</p>'}
          </div>
          <button class="btn-save" onclick="exportHistory()" style="margin-top:16px;">Export History as Text</button>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function exportHistory() {
      if (historyLog.length === 0) return alert("No history to export.");
      let text = "Gage Tracker History Log\nExported: " + new Date().toLocaleString() + "\n\n";
      historyLog.slice().reverse().forEach(entry => {
        text += `Date: ${entry.timestamp}\nEmployee: ${entry.employee}\nAction: ${entry.action}\n`;
        if (entry.details) {
          text += "Details:\n";
          Object.entries(entry.details).forEach(([k, v]) => text += `  ${k}: ${v}\n`);
        }
        text += "----------------------------------------\n\n";
      });
      const blob = new Blob([text], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gage-history-${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      alert('History exported as readable text file!');
    }

    function searchGages(term) {
      loadGages(term);
    }

    function performSearch() {
      loadGages(document.getElementById('searchInput').value.trim());
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('clearSearch').style.display = 'none';
      loadGages('');
    }

    function closePopup() {
      document.querySelectorAll('.popup-overlay').forEach(p => p.remove());
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closePopup(); });

    loadGages();
  </script>
</body>
</html>

